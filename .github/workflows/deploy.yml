name: Deploy Next.js + Express with CDK

on:
  push:
    branches: 
      - main        # Deploy to prod
      - develop     # Deploy to staging
  pull_request:
    branches: [main, develop]

env:
  AWS_REGION: us-west-1
  NODE_VERSION: '18'

jobs:
  # Determine environment based on branch
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  # Deploy infrastructure with CDK
  infrastructure:
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
    outputs:
      api-endpoint: ${{ steps.deploy.outputs.ApiEndpoint }}
      frontend-url: ${{ steps.deploy.outputs.FrontendUrl }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Check environment secrets
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}
          HASH_SALT: ${{ secrets.HASH_SALT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          HOSTED_ZONE_ID: ${{ secrets.HOSTED_ZONE_ID }}
          CLOUDFRONT_CERTIFICATE_ARN: ${{ secrets.CLOUDFRONT_CERTIFICATE_ARN }}
        run: |
          echo "Checking required environment variables..."
          echo "Environment is ${{ needs.setup.outputs.environment }}"
          REQUIRED_SECRETS=("AWS_ROLE_ARN" "MONGODB_URI" "JWT_SECRET" "REFRESH_SECRET" "HASH_SALT" "EMAIL_USER" "EMAIL_PASS")

          missing=false
          for secret in "${REQUIRED_SECRETS[@]}"; do
            value="${!secret}"
            if [ -z "$value" ]; then
              echo "❌ Missing secret or env variable: $secret"
              missing=true
            else
              echo "✅ Found $secret (length: ${#value})"
            fi
          done

          if [ "$missing" = true ]; then
            echo "Error: One or more required secrets are missing."
            exit 1
          fi
          
          # Check optional domain configuration - ALL THREE must be present
          if [ -n "$DOMAIN_NAME" ] && [ -n "$HOSTED_ZONE_ID" ] && [ -n "$CLOUDFRONT_CERTIFICATE_ARN" ]; then
            echo "✅ Custom domain configuration complete"
            echo "   Domain: $DOMAIN_NAME"
            echo "   Hosted Zone ID: $HOSTED_ZONE_ID"
            echo "   CloudFront Cert ARN: ${CLOUDFRONT_CERTIFICATE_ARN:0:50}..."
          else
            echo "ℹ️  No custom domain configured - will use AWS-generated URLs"
            if [ -n "$DOMAIN_NAME" ] || [ -n "$HOSTED_ZONE_ID" ] || [ -n "$CLOUDFRONT_CERTIFICATE_ARN" ]; then
              echo "⚠️  Warning: Partial domain configuration detected. All three secrets required:"
              echo "   - DOMAIN_NAME"
              echo "   - HOSTED_ZONE_ID"
              echo "   - CLOUDFRONT_CERTIFICATE_ARN"
            fi
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install CDK dependencies
        working-directory: infrastructure
        run: npm ci
      
      - name: Deploy infrastructure
        id: deploy
        working-directory: infrastructure
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          HOSTED_ZONE_ID: ${{ secrets.HOSTED_ZONE_ID }}
          CLOUDFRONT_CERTIFICATE_ARN: ${{ secrets.CLOUDFRONT_CERTIFICATE_ARN }}
        run: |
          # Build CDK command with base parameters
          CDK_CMD="npx cdk deploy --all --require-approval never \
            --context environment=${{ needs.setup.outputs.environment }} \
            --context mongodb-uri=\"${{ secrets.MONGODB_URI }}\" \
            --context jwt-secret=\"${{ secrets.JWT_SECRET }}\" \
            --context refresh-secret=\"${{ secrets.REFRESH_SECRET }}\" \
            --context email-user=\"${{ secrets.EMAIL_USER }}\" \
            --context email-pass=\"${{ secrets.EMAIL_PASS }}\" \
            --context hash-salt=\"${{ secrets.HASH_SALT }}\""
          
          # Add domain configuration ONLY if ALL THREE are present and non-empty
          if [ -n "$DOMAIN_NAME" ] && [ -n "$HOSTED_ZONE_ID" ] && [ -n "$CLOUDFRONT_CERTIFICATE_ARN" ]; then
            echo "Deploying with custom domain: $DOMAIN_NAME"
            CDK_CMD="$CDK_CMD \
              --context domain-name=\"$DOMAIN_NAME\" \
              --context hosted-zone-id=\"$HOSTED_ZONE_ID\" \
              --context cloudfront-certificate-arn=\"$CLOUDFRONT_CERTIFICATE_ARN\""
          else
            echo "Deploying without custom domain (using AWS-generated URLs)"
          fi
          
          # Add outputs file
          CDK_CMD="$CDK_CMD --outputs-file outputs.json"
          
          # Execute deployment
          eval $CDK_CMD
          
          # Export outputs for other jobs
          STACK_NAME="AdminPortalServerStack-${{ needs.setup.outputs.environment }}"
          echo "ApiEndpoint=$(cat outputs.json | jq -r ".\"$STACK_NAME\".ApiEndpoint")" >> $GITHUB_OUTPUT
          echo "FrontendUrl=$(cat outputs.json | jq -r ".\"$STACK_NAME\".FrontendUrl")" >> $GITHUB_OUTPUT

  # Deployment summary
  summary:
    needs: [setup, infrastructure]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && always()
    steps:
      - name: Deployment Summary
        run: |
          echo "### 🚀 Deployment Complete - ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **API Endpoint**: ${{ needs.infrastructure.outputs.api-endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: ${{ needs.infrastructure.outputs.frontend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Services" >> $GITHUB_STEP_SUMMARY
          echo "- **Express API**: ✅ Deployed via CDK" >> $GITHUB_STEP_SUMMARY
          echo "- **Next.js Frontend**: ✅ Deployed via CDK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🎉 All services deployed successfully!" >> $GITHUB_STEP_SUMMARY